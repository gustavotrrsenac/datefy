<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanças - DateFY</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <aside class="sidebar">
    <h2 class="logo">Date<span>FY</span></h2>
    <ul>
      <li><a href="{{ url_for('dashboard') }}"> Visão Geral</a></li>
      <li><a href="{{ url_for('vida_pessoal') }}"> Vida Pessoal</a></li>
      <li><a href="{{ url_for('financas') }}" class="active"> Finanças</a></li>
      <li><a href="{{ url_for('perfil') }}"> Perfil</a></li>
      <li><a href="{{ url_for('logout') }}"> Sair</a></li>
    </ul>
  </aside>

  <main>
    <h1 class="titulo-pagina">Finanças</h1> 

    <section class="painel-info">
      <h3>Registrar nova transação</h3>
      <form method="POST" class="form-financa" style="display:flex;flex-direction:column;gap:10px;max-width:720px;">
        <!-- Se usar Flask-WTF/CSRFProtect, mantenha o token: -->
        {% if csrf_token %}
          {{ csrf_token() }}
        {% endif %}

        <input name="descricao" placeholder="Descrição (ex: Conta de luz)" />
        <select name="categoria" required>
          <option value="">Categoria</option>
          {% for c in categorias %}
            <option value="{{ c.key }}">{{ c.label }}</option>
          {% endfor %}
        </select>

        <div style="display:flex;gap:8px;">
          <select name="tipo" required>
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>

          <input name="valor" type="number" step="0.01" min="0" placeholder="Valor (ex: 125.90)" required>
          <input name="data" type="date" />
        </div>

        <div style="display:flex;gap:8px;">
          <input name="forma_pagamento" placeholder="Forma de pagamento (ex: Cartão/Boleto/Dinheiro)" />
          <input name="parcelas" type="number" min="1" placeholder="Parcelas (opcional)" />
        </div>

        <button type="submit" class="btn-padrao">Salvar</button>
      </form>
    </section>

    <section class="painel-info" style="margin-top:20px;">
      <h3>Resumo</h3>
      <div style="display:flex;gap:20px;flex-wrap:wrap;">
        <div style="background:#132d42;color:#fff;padding:14px;border-radius:10px;min-width:160px;">
          <div>Total Entradas</div>
          <div id="total-entradas">R$ 0.00</div>
        </div>
        <div style="background:#132d42;color:#fff;padding:14px;border-radius:10px;min-width:160px;">
          <div>Total Saídas</div>
          <div id="total-saidas">R$ 0.00</div>
        </div>
      </div>

      <div style="margin-top:20px; max-width:230px; text-align:center">
        <canvas id="chartCategorias" width="230" height="460"> </canvas>
      </div>
    </section>

    <section class="painel-info" style="margin-top:20px;">
      <h3>Últimos lançamentos</h3>
      <table style="width:100%;border-collapse:collapse;">
        <thead style="text-align:left;color:#cbd8e4;">
          <tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Ações</th></tr>
        </thead>
        <tbody style="color:white;">
          {% for r in registros %}
          <tr class="linha-registro"
          data-id="{{ r['id'] }}"
          data-descricao="{{ r['descricao'] }}"
          data-categoria="{{ r['categoria'] }}"
          data-tipo="{{ r['tipo'] }}"
          data-valor="{{ '%.2f'|format(r['valor']) }}"
          data-data="{{ r['data'] }}"
          data-forma="{{ r['forma_pagamento'] }}"
          data-parcelas="{{ r['parcelas'] }}">
      
              <td style="padding:8px 6px;">{{ r['data'] }}</td>
              <td>{{ r['descricao'] }}</td>
              <td>{{ r['categoria'] }}</td>
              <td>{{ r['tipo'] }}</td>
              <td>R$ {{ "%.2f"|format(r['valor']) }}</td>
              <td>
                <!-- usa url_for, confirmação JS e token CSRF se necessário -->
                <form action="{{ url_for('apagar_registro', id=r['id']) }}" method="POST" style="margin:0;display:inline;">
                  {% if csrf_token %}
                    {{ csrf_token() }}
                  {% endif %}
                  <button type="submit"
                          onclick="return confirm('Deseja realmente excluir este registro?')"
                          style="background-color:#132d42;color:white;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;">
                    excluir
                  </button>
                </form>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="6">Nenhum registro ainda.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>

  <script>
    async function atualizarResumo() {
      const res = await fetch("{{ url_for('financas_data') }}");
      const data = await res.json();
      if(data.error) return;
      document.getElementById("total-entradas").innerText = "R$ " + (data.totais.entrada || 0).toFixed(2);
      document.getElementById("total-saidas").innerText = "R$ " + (data.totais.saida || 0).toFixed(2);
  
      const ctx = document.getElementById("chartCategorias").getContext('2d');
      if(window._chartCategorias) window._chartCategorias.destroy();
      window._chartCategorias = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.por_categoria.labels,
          datasets: [{ data: data.por_categoria.values, backgroundColor: data.por_categoria.colors }]
        },
        options: { responsive:true, plugins:{ legend:{ labels: {
                    color: 'white',
                    font: {
                        size: 14
                    }
                } } } }
      });
    }
    document.addEventListener('DOMContentLoaded', atualizarResumo);
  </script>
  
<!--  MODAL DE DETALHES ESTILIZADO -->
<div id="modal-detalhes" style="
position: fixed;
inset: 0;
background: rgba(0,0,0,0.55);
display: none;
align-items: center;
justify-content: center;
z-index: 9999;
backdrop-filter: blur(3px);
">
<div id="modal-box" style="
  background: #0f2535;
  padding: 24px;
  width: 380px;
  color: #dce7f2;
  border-radius: 14px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  transform: scale(0.85);
  opacity: 0;
  transition: 0.25s ease;
">
  <h2 style="margin-top:0;color:#fff;text-align:center;">Detalhes do Registro</h2>
  <hr style="border:0;border-top:1px solid #355a77;margin:10px 0 18px;">

  <p><strong>Descrição:</strong> <span id="det-descricao"></span></p>
  <p><strong>Categoria:</strong> <span id="det-categoria"></span></p>
  <p><strong>Tipo:</strong> <span id="det-tipo"></span></p>
  <p><strong>Valor:</strong> R$ <span id="det-valor"></span></p>
  <p><strong>Data:</strong> <span id="det-data"></span></p>
  <p><strong>Forma de pagamento:</strong> <span id="det-forma"></span></p>
  <p><strong>Parcelas:</strong> <span id="det-parcelas"></span></p>

  <button onclick="fecharModal()" style="
    background:#1B3C53;
    padding:10px 14px;
    border:none;
    border-radius:8px;
    color:white;
    cursor:pointer;
    width:100%;
    margin-top:15px;
    font-size:15px;
    transition:0.2s;
  " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
    Fechar
  </button>
</div>
</div>

<script>
function abrirModal(linha) {
document.getElementById("det-descricao").innerText = linha.dataset.descricao;
document.getElementById("det-categoria").innerText = linha.dataset.categoria;
document.getElementById("det-tipo").innerText = linha.dataset.tipo;
document.getElementById("det-valor").innerText = linha.dataset.valor;
document.getElementById("det-data").innerText = linha.dataset.data;
document.getElementById("det-forma").innerText = linha.dataset.forma || "—";
document.getElementById("det-parcelas").innerText = linha.dataset.parcelas || "—";

const modal = document.getElementById("modal-detalhes");
const box = document.getElementById("modal-box");

modal.style.display = "flex";

setTimeout(() => {
  box.style.transform = "scale(1)";
  box.style.opacity = "1";
}, 10);
}

function fecharModal() {
const modal = document.getElementById("modal-detalhes");
const box = document.getElementById("modal-box");

box.style.transform = "scale(0.85)";
box.style.opacity = "0";

setTimeout(() => {
  modal.style.display = "none";
}, 200);
}

// fechar clicando fora da caixa
document.getElementById("modal-detalhes").addEventListener("click", function(e) {
if (e.target === this) fecharModal();
});

// ativar clique nas linhas
document.querySelectorAll(".linha-registro").forEach(linha => {
linha.style.cursor = "pointer";
linha.addEventListener("click", () => abrirModal(linha));
});
</script>
</body>
</html>
