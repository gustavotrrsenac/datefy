<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DateFY</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="static/css/style.css">
  <link rel="icon" href="/static/imagens/PHOTO-2025-10-30-23-41-32.jpg">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
</head>

<body>

  <aside class="sidebar">
    <h2 class="logo">Date<span>FY</span></h2>
    <ul>
      <li><a href="{{ url_for('dashboard') }}" class="active"> VisÃ£o Geral</a></li>
      <li><a href="{{ url_for('vida_pessoal') }}"> Vida Pessoal</a></li>
      <li><a href="{{ url_for('financas') }}"> FinanÃ§as</a></li>
      <li><a href="{{ url_for('perfil') }}"> Perfil</a></li>
      <li><a href="{{ url_for('logout') }}"> Sair</a></li>
    </ul>
  </aside>

  <main>

    <h1 class="titulo-pagina">OlÃ¡, {{ nome }} </h1>

    <!-- Painel dos cards -->
    <section class="cards-dashboard">
      <div class="card-box">
        <h3>Tarefas do dia</h3>
<<<<<<< HEAD
        <p id="dash-tarefas">0</p>
      </div>  
=======
        <p id="dash-tarefas"> {{td}}</p>
      </div>
>>>>>>> d2238f734503b509d97e8595045b094460aad966

      <div class="card-box entrada">
        <h3>Entradas</h3>
        <p id="dash-entradas">R$ {{entradas}}</p>
      </div>

      <div class="card-box saida">
        <h3>SaÃ­das</h3>
        <p id="dash-saidas">R$ {{saidas}}</p>
      </div>

      <div class="card-box total">
        <h3>Total</h3>
        <p id="dash-total">R$ {{tg}}</p>
      </div>
    </section>

    <!-- CALENDÃRIO -->
    <section class="painel-info" style="margin-top:18px;">
      <h3>CalendÃ¡rio</h3>
      <div id="calendar"></div>

      <div id="eventos-dia">
        <h4>Eventos do Dia</h4>
        <ul id="lista-eventos"></ul>
      </div>

      <!-- INPUT DE EVENTOS EM JSON -->
      <input type="text" id="eventosInput" value='[
      {"title":"Pagamento","start":"2025-02-10"},
      {"title":"ReuniÃ£o","start":"2025-02-15"}
      ]' hidden>

    </section>
    

    

    <!-- LEMBRETES  -->
    <section class="painel-info" style="margin-top:18px;">
      <h3>Lembretes</h3>
    
      <table class="tabela-lembretes">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>DescriÃ§Ã£o</th>
            <th>Data</th>
            <th>Status</th>
          </tr>
        </thead>
    
        <tbody>
          {% if tarefas %}
            {% for t in tarefas %}
              <tr>
                <td>Tarefa</td>
                <td>{{ t['titulo'] }}</td>
                <td>{{ t['data'] }}</td>
    
                {% if t['status'] == 1 %}
                  <td>ğŸŸ© ConcluÃ­da</td>
                {% else %}
                  <td>ğŸŸ¨ Pendente</td>
                {% endif %}
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4">Nenhuma tarefa cadastrada ainda.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section class="bloco-dashboard">
      <h2>ğŸ“ Suas Tarefas Recentes</h2>
    
      {% if tarefas %}
        <ul class="lista-dashboard">
          {% for t in tarefas %}
            <li class="item-tarefa {% if t['status'] == 1 %}concluida{% endif %}">
              <strong>{{ t['titulo'] }}</strong>
              <small>{{ t['data'] }}</small>
              <span class="categoria">{{ t['categoria'] or 'Geral' }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Nenhuma tarefa cadastrada ainda.</p>
      {% endif %}
    </section>
    

  </main>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        height: 'auto',

<<<<<<< HEAD
        /* ROTA CORRETA */
        events: "{{ url_for('api_tarefas') }}",
=======
        
        /* EVENTOS */
        events: '/api/tarefas',
>>>>>>> d2238f734503b509d97e8595045b094460aad966

        eventDisplay: "list-item",

        dateClick: function(info) {
          const dataFormatada = info.dateStr.split("T")[0];

          const eventosDoDia = calendar.getEvents().filter(ev => {
            return ev.startStr && ev.startStr.startsWith(dataFormatada);
          });

          const lista = document.getElementById("lista-eventos");
          lista.innerHTML = "";

          if (eventosDoDia.length === 0) {
            lista.innerHTML = "<li>Nenhum evento neste dia.</li>";
          } else {
            eventosDoDia.forEach(ev => {
              const li = document.createElement("li");
              li.textContent = ev.title;
              lista.appendChild(li);
            });
          }

          document.getElementById("eventos-dia").style.display = "block";
        },

        eventClick: function(info) {
          info.jsEvent.preventDefault();
          const ev = info.event;
          const detalhes = [
            "TÃ­tulo: " + ev.title,
            ev.extendedProps.tipo ? ("Tipo: " + ev.extendedProps.tipo) : null,
            ev.start ? ("Data: " + ev.start.toISOString().split("T")[0]) : null
          ].filter(Boolean).join(" â€” ");

          alert(detalhes);
        },

        eventClassNames: function(arg) {
          if (arg.event.title && arg.event.title.startsWith("Tarefa:")) {
            return ['tarefa-evento'];
          }
          return [];
        }

      });

      calendar.render();

      fetch('/financas/data').then(r => r.json()).then(data => {
        if (data && data.totais) {
          document.getElementById('dash-entradas').textContent = "R$ " + (data.totais.entrada||0).toFixed(2);
          document.getElementById('dash-saidas').textContent = "R$ " + (data.totais.saida||0).toFixed(2);
          const total = (data.totais.entrada||0) - (data.totais.saida||0);
          document.getElementById('dash-total').textContent = "R$ " + total.toFixed(2);
        }
      }).catch(()=>{});

      fetch('/eventos-json').then(r => r.json()).then(list => {
        const hoje = new Date().toISOString().split('T')[0];
        const tarefasHoje = list.filter(ev => ev.title && ev.title.startsWith("Tarefa:") && ev.start && ev.start.startsWith(hoje));
        document.getElementById('dash-tarefas').textContent = tarefasHoje.length;
      }).catch(()=>{});

    });
  </script>

</body>
</html>
